# Прянишников Александр. Тестовое задание на позицию стажера-бекендера
Здесь выложен код к тестовому заданию в Avito.

## ТЗ

Необходимо реализовать микросервис для работы с балансом пользователей (зачисление средств, списание средств, перевод
средств от пользователя к пользователю, а также метод получения баланса пользователя). Сервис должен предоставлять HTTP
API и принимать/отдавать запросы/ответы в формате JSON.

## Какой функционал был реализован?

По основному заданию:
- Метод получения баланса пользователя.
- Метод начисления средств на баланс.
- Метод резервирования средств с основного баланса на отдельном счете. 
- Метод признания выручки – списывает из резерва деньги, добавляет данные в отчет для бухгалтерии.
- Метод возврата денег на счёт пользователю, если услугу не удалось применить (сценарий разрезервирования денег).

По дополнительному заданию:
- Метод получения месячного отчёта.
- Метод получения списка транзакций пользователя с комментариями откуда и зачем были начислены/списаны средства с баланса.

Также были выполнены следующие требования:
- Весь микросервис написан на Golang.
- Сервис предоставляет HTTP API с форматом JSON как при отправке запроса, так и при получении результата.
- В качестве реляционной СУБД был использован MySQL.
- Был использован docker и docker-compose для поднятия и развертывания dev-среды.
- Реализован swagger
- Написаны unit и интеграционные тесты.

В качестве дополнения к заданию в проекте есть: 
- Метод перевода средств между пользователями.
- Логирование.
- Использование принципов чистой архитектуры при проектировании и реализации сервиса.
- Всё API имеет префикс /api/v1
- Некоторая документация, например, UML-диаграмма проекта, есть в папке docs/pdf/

## Запуск
Перед запуском нужно освободить два порта: 8080 для сервера и 3306 для БД.
Из корня репозитория запустить следующую команду (возможно, под sudo, у меня работает только под sudo).
```bash
make run
```

### Команды запуска утилит
Для генерации `API Swagger` нужно в корневой директории выполнить команду:
```bash
make generate-api
```

Для запуска тестов нужно в корневой директории выполнить команду:
```bash
make tests
```


# API
## 1. Метод получения баланса пользователя.

```text
GET /api/v1/accounts
```

### Запрос
```text
http://localhost:8080/api/v1/accounts?userID=1
```
- userID - id пользователя

### Ответ
**200 - OK**
```json
{
  "balance": 0,
}
```
**400, 401, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неверный параметр в запросе;
- 401 - пользователь с id = user_id не найден;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'GET' 'http://localhost:8080/api/v1/accounts?userID=1' \
  -H 'accept: application/json'
```

## 2. Метод начисления средств на баланс.

```text
POST /api/v1/accounts/refill
```

### Тело запроса
- user_id - id пользователя
- sum - сумма, которую нужно зачислить (должна быть больше 0)
- comment - подпись к переводу (может быть и пустой)

```json
{
  "comment": "string",
  "sum": 100,
  "user_id": 1
}
```

### Ответ
**200 - OK**
```json
{
  "comment": "OK",
}
```
**400, 401, 422, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неверный параметр в запросе;
- 401 - пользователь с id = user_id не найден;
- 422 - сумма перевода должна быть положительной;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'POST' 'http://localhost:8080/api/v1/accounts/refill' \
  -H 'accept: application/json' -H 'Content-Type: application/json' \
  -d '{
  "comment": "string",
  "sum": 100,
  "user_id": 1
}'
```

## 3. Метод резервирования средств с основного баланса на отдельном счете.

```text
POST /api/v1/services/buy
```

### Тело запроса

```json
{
  "comment": "string",
  "order_id": 0,
  "service_id": 0,
  "sum": 0,
  "user_id": 0
}
```
- comment - комментарий;
- order_id - id заказа;
- service_id - id услуги;
- sum - сумма перевода;
- user_id - id пользователя
### Ответ
**200 - OK**
```json
{
  "comment": "OK",
}
```
**400, 401, 422, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неправильные параметры в запросе/не все параметры переданы;
- 401 - пользователя с id = user_id не существует;
- 422 - недостаточно средств для совершения покупки;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'POST' 'http://localhost:8080/api/v1/services/buy' \
  -H 'accept: application/json' -H 'Content-Type: application/json' \
  -d '{
  "comment": "string",
  "order_id": 0,
  "service_id": 0,
  "sum": 0,
  "user_id": 0
}'
```

## 4. Метод признания выручки.
```text
POST /api/v1/services/accept
```

### Тело запроса

```json
{
  "order_id": 0,
  "service_id": 0,
  "user_id": 0
}
```
- order_id - id заказа;
- service_id - id услуги;
- user_id - id пользователя

### Ответ
**200 - OK**
```json
{
  "comment": "OK",
}
```
**400, 401, 403, 404, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неправильные параметры в запросе/не все параметры переданы;
- 401 - пользователя с id = user_id не существует;
- 403 - у заказа неподходящий статус для подтверждения услуги (например, уже подтверждение произошло);
- 404 - заказ не найден в системе;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'POST' 'http://localhost:8080/api/v1/services/accept' \
  -H 'accept: application/json' -H 'Content-Type: application/json' \
  -d '{
  "order_id": 0,
  "service_id": 0,
  "user_id": 0
}'
```

## 5. Метод возврата денег на счёт пользователю, если услугу не удалось применить.
```text
POST /api/v1/services/refuse
```

### Тело запроса

```json
{
  "comment": "string",
  "order_id": 0,
  "service_id": 0,
  "user_id": 0
}
```
- comment - комментарий;
- order_id - id заказа;
- service_id - id услуги;
- user_id - id пользователя

### Ответ
**200 - OK**
```json
{
  "comment": "OK",
}
```
**400, 401, 403, 404, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неправильные параметры в запросе/не все параметры переданы;
- 401 - пользователя с id = user_id не существует;
- 403 - у заказа неподходящий статус для подтверждения услуги (например, уже подтверждение произошло);
- 404 - заказ не найден в системе;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'POST' 'http://localhost:8080/api/v1/services/refuse' \
  -H 'accept: application/json' -H 'Content-Type: application/json' \
  -d '{
  "comment": "string",
  "order_id": 0,
  "service_id": 0,
  "user_id": 0
}'
```

## 6. Метод получения месячного отчёта.
```text
POST /api/v1/reports/finance
```

### Запрос

```text
http://localhost:8080/api/v1/reports/finance?month=1&year=2022
}
```
- month - месяц, по которому нужно сделать отчёт (от 1 до 12);
- year - месяц, по которому нужно сделать отчёт (от 1960 до 2024);

### Ответ
**200 - OK**
```json
{
  "fileURL": "report.csv",
}
```
**400, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неправильные параметры в запросе/месяц и год указаны некорректно;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'GET' \
  'http://localhost:8080/api/v1/reports/finance?month=1&year=2022' \
  -H 'accept: application/json'
}'
```

## 7. Метод получения списка транзакций пользователя с комментариями откуда и зачем были начислены/списаны средства с баланса.
```text
GET api/v1/reports/user
```

### Запрос

```text
http://localhost:8080/api/v1/reports/user?userID=1&orderBy=id&limit=12&offset=1
}
```
- userID - пользователь, по которому нужно получить отчёт;
- orderBy - поле, по которому сортировать (либо id, либо time, либо sum, иначе все равно сортировка будет по id). Опционально;
- limit - количество записей, которые нужно вернуть. Опционально;
- offset - индекс записи, начиная с которой нужно вернуть записи. Опционально;

### Ответ
**200 - OK**
```json
{
  "transactions": [
    {
      "actionComments": "string",
      "addComments": "string",
      "sum": 0,
      "time": "string",
      "transactionID": 0,
      "transactionType": 0,
      "userID": 0
    }
  ]
}
```
**400, 401, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неправильные параметры в запросе;
- 401 - пользователь с id = user_id не найден в системе;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'GET' \
  'http://localhost:8080/api/v1/reports/user?userID=1&orderBy=id&limit=12&offset=1' \
  -H 'accept: application/json'
}'
```

## 8. Метод перевода средств между пользователями.
```text
POST /api/v1/transfer
```

### Тело запроса

```json
{
  "comment": "string",
  "dst_user_id": 0,
  "src_user_id": 0,
  "sum": 0
}
```
- src_user_id - id пользователя, который отправляет деньги;
- dst_user_id - id пользователя, который получает деньги;
- sum - сумма перевода  (должна быть больше 0);
- comment - комментарий.

### Ответ
**200 - OK**
```json
{
  "comment": "OK",
}
```
**400, 401, 422, 500**
```json
{
  "error": "string"
}
```

### Описание кодов ответа
- 200 - OK;
- 400 - неправильные параметры в запросе/не все параметры переданы;
- 401 - пользователя с id = dst_user_id или src_user_id не существует;
- 422 - недостаточно средств для совершения транзакции или сумма перевода не положительная;
- 500 - ошибка сервера.

Пример запроса в bash
```bash
curl -X 'POST' 'http://localhost:8080/api/v1/transfer' \
  -H 'accept: application/json' -H 'Content-Type: application/json' \
  -d '{
  "comment": "string",
  "dst_user_id": 0,
  "src_user_id": 0,
  "sum": 0
}'
```
